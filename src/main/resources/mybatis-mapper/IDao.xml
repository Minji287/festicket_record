<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0/EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.festicket.dao.IDao">

	<!-- ***메인 페이지(index)*** -->
	
	<!-- 검색 결과 가져오기 -->
	<select id="getSearchResult" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param2}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice 
			 	FROM event
			 	WHERE UPPER(title) LIKE '%' || #{param1} || '%'
			 	OR UPPER(type) LIKE '%' || #{param1} || '%'
	        ) A
	    )
	    WHERE PAGE=#{param3}
	</select>
	
	<select id="totalSearchResultCount" resultType="int">
	    SELECT COUNT(*)
	    FROM event
	    WHERE UPPER(title) LIKE '%' || #{param1} || '%'
	    OR UPPER(type) LIKE '%' || #{param1} || '%'
	</select>
	
	<!-- 페스티벌 탑5 리스트 / 예매율 = (예매된 티켓 수 / 전체 좌석 수) * 100-->
	<select id="top5FestivalListDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, gunName, type
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount,
		           RANK() OVER (ORDER BY (COUNT(er.re_eventNum) / e.ticketCount)*100 DESC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5 AND UPPER(type) LIKE '축제%'
	</select>
	
	<!-- 전시 탑5 리스트 -->
	<select id="top5ExhibitionListDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, gunName, type
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount,
		           RANK() OVER (ORDER BY (COUNT(er.re_eventNum) / e.ticketCount)*100 DESC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5 AND UPPER(type) LIKE '전시%'
	</select>

<!--
	<select id="contentViewDao" resultType="com.festicket.dto.EventDto">
		SELECT * FROM event WHERE eventNum=${param1}
	</select>
	
	<delete id="deleteDao">
		DELETE FROM event WHERE eventNum=${param1}
	</delete>
-->
	
	<!-- 행사 관련 -->
	<select id="eventListDao" resultType="com.festicket.dto.EventDto">
		SELECT * FROM event ORDER BY eventNum DESC
	</select>
	
	<select id="totalEventCountDao" resultType="int">
		SELECT COUNT(*) FROM event
	</select>
	
	<!-- *** 랭킹 페이지 *** -->
	
	<!-- 예매 수가 같을경우 총 티켓의 수가 적은 순(수정필요)으로 정렬 -->
	<select id="getTopFiveEventsDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, eventDate
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.eventDate, e.ticketCount,
		           RANK() OVER (ORDER BY COUNT(er.re_eventNum) DESC, e.ticketCount ASC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.eventDate, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5
	</select>
	
	<select id="getEventDao" resultType="com.festicket.dto.EventDto">
		SELECT *
		FROM event
		WHERE eventNum=#{param1}
	</select>
	
	<!-- 날짜비교 - 진행중인 이벤트 조회 -->
	<select id="getOngoingEventDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, title, place, rgstDate, end_date, gunName
		  FROM event
		WHERE end_date <![CDATA[>]]>= SYSDATE
		AND start_date <![CDATA[<]]>= SYSDATE
		AND rgstDate <![CDATA[<]]>= SYSDATE
	</select>
	 
	 <!-- 축제 페이지 -->
	 <select id="festivalListDao" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice
	            FROM event
	            WHERE UPPER(type) LIKE '축제%'
	            ORDER BY eventNum DESC
	        ) A
	    )
	    WHERE PAGE=#{param2}
	 </select>
	 
	 <select id="totalFestivalCountDao" resultType="int">
		SELECT COUNT(*) FROM event WHERE UPPER(type) LIKE '축제%'
	</select>
	 
	<!-- 전시 페이지 -->
	 <select id="exhibitionListDao" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice
	            FROM event
	            WHERE UPPER(type) LIKE '전시%'
	            ORDER BY eventNum DESC
	        ) A
	    )
	    WHERE PAGE=#{param2}
	 </select>
	 
	 <select id="totalExhibitionCountDao" resultType="int">
		SELECT COUNT(*) FROM event WHERE UPPER(type) LIKE '전시%'
	</select>
	
	<!-- 리뷰 글 가져오기 -->
	<select id="getReviewListDao" resultType="com.festicket.dto.ReviewDto">
		SELECT *
		  FROM eventReview er
		  LEFT OUTER JOIN event e
		    ON er.rw_eventNum = e.eventNum
		 WHERE er.rw_eventNum=${param1}
	</select>
	
	<!-- QA 글 가져오기 -->
	<select id="getQAListDao" resultType="com.festicket.dto.QABoardDto">
		SELECT *
		  FROM event_QABoard er
		  LEFT OUTER JOIN event e
		    ON er.q_eventNum = e.eventNum
		 WHERE er.q_eventNum=${param1}
	</select>
	
	<!-- 고객센터 페이지 -->
	<select id="csListDao" resultType="com.festicket.dto.CSboardDto">
		SELECT *
		FROM (
		    SELECT A.*, FLOOR(((ROWNUM - 1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
		    FROM (
		        SELECT *
		        FROM eventCSboard
		        ORDER BY c_idx DESC
		    ) A
		) B
		WHERE PAGE = #{param2}
	</select>
	
	<insert id="csWriteDao">
		INSERT INTO 
			eventCSboard(c_idx, c_userId, c_title, c_content, c_hit, c_replyCount)
				VALUES
					(ecs_seq.nextval, #{param1}, #{param2}, #{param3}, 0, 0)
	</insert>
	
	<select id="csViewDao" resultType="com.festicket.dto.CSboardDto">
		SELECT * FROM eventCSboard WHERE c_idx=#{param1}
	</select>
	
	<delete id="csDeleteDao">
		DELETE FROM eventCSboard WHERE c_idx=#{param1}
	</delete>
	
	<update id="csHitDao">
		UPDATE eventCSboard SET c_hit=c_hit+1 WHERE c_idx=#{param1}
	</update>
	
	<select id="totalCSListCountDao" resultType="int">
		SELECT COUNT(*) FROM eventCSboard
	</select>
	
</mapper>