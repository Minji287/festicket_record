<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0/EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.festicket.dao.IDao">

	<!-- ***메인 페이지(index)*** -->
	<!-- 검색 결과 가져오기 -->
	<select id="getSearchResult" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param2}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice 
			 	FROM event
			 	WHERE UPPER(title) LIKE '%' || #{param1} || '%'
			 	OR UPPER(type) LIKE '%' || #{param1} || '%'
	        ) A
	    )
	    WHERE PAGE=#{param3}
	</select>
	
	<select id="totalSearchResultCount" resultType="int">
	    SELECT COUNT(*)
	    FROM event
	    WHERE UPPER(title) LIKE '%' || #{param1} || '%'
	    OR UPPER(type) LIKE '%' || #{param1} || '%'
	</select>
	
	<!-- 페스티벌 탑5 리스트 / 예매율 = (예매된 티켓 수 / 전체 좌석 수) * 100-->
	<select id="top5FestivalListDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, gunName, type
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount,
		           RANK() OVER (ORDER BY (COUNT(er.re_eventNum) / e.ticketCount)*100 DESC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5 AND UPPER(type) LIKE '축제%'
	</select>
	
	<!-- 전시 탑5 리스트 -->
	<select id="top5ExhibitionListDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, gunName, type
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount,
		           RANK() OVER (ORDER BY (COUNT(er.re_eventNum) / e.ticketCount)*100 DESC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5 AND UPPER(type) LIKE '전시%'
	</select>

	<!-- 행사 관련 -->
	<select id="eventListDao" resultType="com.festicket.dto.EventDto">
		SELECT * FROM event ORDER BY eventNum DESC
	</select>
	
	<select id="totalEventCountDao" resultType="int">
		SELECT COUNT(*) FROM event
	</select>
	
	<!-- admin 관련 -->
   <select id="eventListPagingDao" resultType="com.festicket.dto.EventDto">
       SELECT eventNum, gunName, title, eventDate
       FROM (
           SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
           FROM (
               SELECT eventNum, gunName, title, eventDate
               FROM event
               ORDER BY eventNum DESC
           ) A
       )
       WHERE PAGE=#{param2}
    </select>
    
    <insert id="eventAddDao">
       INSERT INTO event
       VALUES(e_seq.nextval, #{param1}, #{param2}, #{param3}, #{param4}, #{param5}, #{param6}, 
             #{param7}, #{param8}, #{param9}, #{param10}, #{param11}, #{param12}, #{param13}, #{param14})
    </insert>
	
	<!-- *** 랭킹 페이지 *** -->
	<!-- 예매 수가 같을경우 총 티켓의 수가 적은 순(수정필요)으로 정렬 -->
	<select id="getTopFiveEventsDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, eventDate
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.eventDate, e.ticketCount,
		           RANK() OVER (ORDER BY COUNT(er.re_eventNum) DESC, e.ticketCount ASC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.eventDate, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5
	</select>
	
	<select id="getEventDao" resultType="com.festicket.dto.EventDto">
		SELECT *
		FROM event
		WHERE eventNum=#{param1}
	</select>
	
	<!-- 진행중인 이벤트 조회 -->
	<select id="getOngoingEventDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, title, place, rgstDate, end_date, gunName
		  FROM event
		WHERE end_date <![CDATA[>]]>= SYSDATE
		AND start_date <![CDATA[<]]>= SYSDATE
		AND rgstDate <![CDATA[<]]>= SYSDATE
	</select>
	 
	 <!-- 축제 페이지 -->
	 <select id="festivalListDao" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice
	            FROM event
	            WHERE UPPER(type) LIKE '축제%'
	            ORDER BY eventNum DESC
	        ) A
	    )
	    WHERE PAGE=#{param2}
	 </select>
	 
	 <select id="totalFestivalCountDao" resultType="int">
		SELECT COUNT(*) FROM event WHERE UPPER(type) LIKE '축제%'
	</select>
	 
	<!-- 전시 페이지 -->
	 <select id="exhibitionListDao" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice
	            FROM event
	            WHERE UPPER(type) LIKE '전시%'
	            ORDER BY eventNum DESC
	        ) A
	    )
	    WHERE PAGE=#{param2}
	 </select>
	 
	 <select id="totalExhibitionCountDao" resultType="int">
		SELECT COUNT(*) FROM event WHERE UPPER(type) LIKE '전시%'
	</select>
	
	<!-- *** 상세 예매 페이지 *** -->
	<!-- 리뷰 글 가져오기 -->
	<select id="getReviewListDao" resultType="com.festicket.dto.ReviewDto">
		SELECT *
		  FROM eventReview er
		  LEFT OUTER JOIN event e
		    ON er.rw_eventNum = e.eventNum
		 WHERE er.rw_eventNum=#{param1}
	</select>
	
	<!-- 리뷰 좋아요 -->
	<insert id="reviewLiker">
		INSERT INTO eventReviewLike
		VALUES(#{param1}, #{param2})
	</insert>
	
	<!-- 행사 좋아요 -->
	<insert id="eventLiker">
		INSERT INTO eventLike
		VALUES(#{param1}, #{param2})
	</insert>
	
	<!-- 리뷰 좋아요 취소 -->
	<delete id="reviewEventLiker">
		DELETE FROM eventReviewLike
		WHERE reviewIdx=#{param1} AND reviewLikerId=#{param2}
	</delete>
	
	<!-- 행사 좋아요 취소 -->
	<delete id="cancelEventLiker">
		DELETE FROM eventLike
		WHERE eventIdx=#{param1} AND eventLikerId=#{param2}
	</delete>
	
	<!-- QA -->
	<select id="getQAListDao" resultType="com.festicket.dto.QABoardDto">
		SELECT *
		  FROM event_QABoard er
		  LEFT OUTER JOIN event e
		    ON er.q_eventNum = e.eventNum
		 WHERE er.q_eventNum=#{param1}
	</select>
	
	<select id="getQaDao" resultType="com.festicket.dto.QABoardDto">
		SELECT *
		FROM event_QABoard
		WHERE q_idx=#{param1}
	</select>
	
	<update id="qaHitDao">
		UPDATE event_QABoard SET q_hit=q_hit+1 WHERE q_idx=#{param1}
	</update>
	
	<!-- *** 예약 *** -->
	<!-- 예약확인 -->
	<select id="getReservationDao" resultType="com.festicket.dto.ReserveDto">
		SELECT *
		FROM (
		    SELECT *
		    FROM eventReservation
		    WHERE re_eventNum = #{param1} AND re_userId=#{param2}
		    ORDER BY re_idx DESC
		)
		WHERE ROWNUM <![CDATA[<=]]>1
	
	<!-- 오라클에서는 되는데 여기선 안됨
		SELECT
		    e.main_img, e.title, e.gunName, e.place, er.*
		FROM (
		    SELECT *
		    FROM eventReservation
		    WHERE re_eventNum = #{param1} AND re_userId=#{param2}
		    ORDER BY re_idx DESC
		) er
		LEFT OUTER JOIN event e ON er.re_eventNum = e.eventNum
		WHERE ROWNUM <![CDATA[<=]]>1;
	 -->
	</select>
	
	<!-- 예약db에 넣어주기 -->
	<insert id="reservationConfirmedDao">
		INSERT INTO eventreservation
		VALUES (erev_seq.nextval, #{param1}, #{param2}, #{param3}, #{param4}, #{param5}, #{param6})
	</insert>

	<!-- 고객센터 게시판 관련 -->
	<select id="csListDao" resultType="com.festicket.dto.CSboardDto">
		SELECT *
		FROM (
		    SELECT A.*, FLOOR(((ROWNUM - 1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
		    FROM (
		        SELECT *
		        FROM eventCSboard
		        ORDER BY c_idx DESC
		    ) A
		) B
		WHERE PAGE = #{param2}
	</select>
	
	<insert id="csWriteDao">
		INSERT INTO 
			eventCSboard(c_idx, c_userId, c_title, c_content, c_hit, c_replyCount)
				VALUES
					(ecs_seq.nextval, #{param1}, #{param2}, #{param3}, 0, 0)
	</insert>
	
	<select id="csViewDao" resultType="com.festicket.dto.CSboardDto">
		SELECT * FROM eventCSboard WHERE c_idx=#{param1}
	</select>
	
	<update id="csModifyDao">
		UPDATE eventCSboard SET c_title=#{param2}, c_content=#{param3} WHERE c_idx=#{param1}
	</update>
	
	<delete id="csDeleteDao">
		DELETE FROM eventCSboard WHERE c_idx=#{param1}
	</delete>
	
	<update id="csHitDao">
		UPDATE eventCSboard SET c_hit=c_hit+1 WHERE c_idx=#{param1}
	</update>
	
	<select id="csListTotalCountDao" resultType="int">
		SELECT COUNT(*) FROM eventCSboard
	</select>
	
	
	<!-- 고객센터 검색 관련 -->
	<select id="totalcsSearch_TitleCount" resultType="int">
	    SELECT COUNT(*)
	    FROM eventCSboard
	    WHERE c_title
		LIKE '%' || #{param1} || '%'
	</select>
	
	<select id="totalcsSearch_IdCount" resultType="int">
	    SELECT COUNT(*)
	    FROM eventCSboard
	    WHERE c_userId
		LIKE '%' || #{param1} || '%'
	</select>
	
	<select id="totalcsSearch_ContentCount" resultType="int">
	    SELECT COUNT(*)
	    FROM eventCSboard
	    WHERE c_content
		LIKE '%' || #{param1} || '%'
	</select>
	
	<select id="csSearchTitleDao" resultType="com.festicket.dto.CSboardDto">
		SELECT *
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param2}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT *
		        FROM eventCSboard
		        WHERE c_title
		        LIKE '%' || #{param1} || '%'
		        ORDER BY c_idx DESC
	        ) A
	    )
	    WHERE PAGE=#{param3}
	</select>
	
	<select id="csSearchContentDao" resultType="com.festicket.dto.CSboardDto">
		SELECT *
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param2}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT *
		        FROM eventCSboard
		        WHERE c_content
		        LIKE '%' || #{param1} || '%'
		        ORDER BY c_idx DESC
	        ) A
	    )
	    WHERE PAGE=#{param3}
	</select>
	
	<select id="csSearchWriterDao" resultType="com.festicket.dto.CSboardDto">
		SELECT *
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param2}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT *
		        FROM eventCSboard
		        WHERE c_userID
		        LIKE '%' || #{param1} || '%'
		        ORDER BY c_idx DESC
	        ) A
	    )
	    WHERE PAGE=#{param3}
	</select>
	
	
	<!-- 댓글 관련 -->
	<insert id="replyWriteDao">
		INSERT INTO 
			eventCSanswer(ca_idx, ca_userId, ca_content, ca_boardNum)
				VALUES
					(ecsa_seq.nextval, '관리자', #{param1}, #{param2})
	</insert>
	
	<update id="replyCountDao">
		UPDATE eventCSboard SET c_replyCount=c_replyCount+1 WHERE c_idx=#{param1}
	</update>
	
	<select id="replyListDao" resultType="com.festicket.dto.CSanswerDto">
		SELECT * FROM eventCSanswer WHERE ca_boardNum=#{param1} ORDER BY ca_idx ASC
	</select>
	
	<delete id="replyDeleteDao">
		DELETE FROM eventCSanswer WHERE ca_idx=#{param1}
	</delete>
	
	<update id="replyCountMinusDao">
		UPDATE eventCSboard SET c_replyCount=c_replyCount-1 WHERE c_idx=#{param1}
	</update>
	
	<delete id="boardReplyDeleteDao">
		DELETE FROM eventCSanswer WHERE ca_boardNum=#{param1}
	</delete>
	
</mapper>