<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0/EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.festicket.dao.IDao">

	<!-- ***메인 페이지(index)*** -->
	
	<!-- 검색 결과 가져오기 -->
	<select id="getSearchResult" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param2}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice 
			 	FROM event
			 	WHERE UPPER(title) LIKE '%' || #{param1} || '%'
			 	OR UPPER(type) LIKE '%' || #{param1} || '%'
	        ) A
	    )
	    WHERE PAGE=#{param3}
	</select>
	
	<select id="totalSearchResultCount" resultType="int">
	    SELECT COUNT(*)
	    FROM event
	    WHERE UPPER(title) LIKE '%' || #{param1} || '%'
	    OR UPPER(type) LIKE '%' || #{param1} || '%'
	</select>
	
	<!-- 페스티벌 탑5 리스트 / 예매율 = (예매된 티켓 수 / 전체 좌석 수) * 100-->
	<select id="top5FestivalListDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, gunName, type
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount,
		           RANK() OVER (ORDER BY (COUNT(er.re_eventNum) / e.ticketCount)*100 DESC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5 AND UPPER(type) LIKE '축제%'
	</select>
	
	<!-- 전시 탑5 리스트 -->
	<select id="top5ExhibitionListDao" resultType="com.festicket.dto.EventDto">
		SELECT eventNum, main_img, title, gunName, type
		FROM (
		    SELECT e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount,
		           RANK() OVER (ORDER BY (COUNT(er.re_eventNum) / e.ticketCount)*100 DESC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.eventNum, e.main_img, e.title, e.gunName, e.type, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5 AND UPPER(type) LIKE '전시%'
	</select>

<!-- 페이징
	<select id="eventListDao" resultType="com.festicket.dto.EventDto">
		SELECT * FROM
			(SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1)PAGE, ROWNUM
				FROM
					(SELECT * from event ORDER BY eventNum DESC)A)
						WHERE PAGE=#{param2}
	</select>
-->

<!--
	<select id="contentViewDao" resultType="com.festicket.dto.EventDto">
		SELECT * FROM event WHERE eventNum=${param1}
	</select>
	
	<delete id="deleteDao">
		DELETE FROM event WHERE eventNum=${param1}
	</delete>
-->
	
	<!-- 행사 관련 -->
	<select id="eventListDao" resultType="com.festicket.dto.EventDto">
		SELECT * FROM event ORDER BY eventNum DESC
	</select>
	
	<select id="totalEventCountDao" resultType="int">
		SELECT COUNT(*) FROM event
	</select>
	
	<!-- 예매 수가 같을경우 총 티켓의 수가 적은 순(수정필요)으로 정렬 -->
	<select id="getTopFiveEventsDao" resultType="com.festicket.dto.EventDto">
		SELECT main_img, title, eventDate
		FROM (
		    SELECT e.main_img, e.title, e.eventDate, e.ticketCount,
		           RANK() OVER (ORDER BY COUNT(er.re_eventNum) DESC, e.ticketCount ASC) AS rnk
		    FROM event e
		    LEFT JOIN eventreservation er ON er.re_eventNum = e.eventNum
		    GROUP BY e.main_img, e.title, e.eventDate, e.ticketCount
		)
		WHERE rnk <![CDATA[<]]>= 5
	</select>
	
	<!-- 날짜비교 
	<select id="getOngoingEventDao" resultMap="com.festicket.dto.EventDto">
		SELECT title, place, rgstDate, end_date
		  FROM event
		WHERE end_date <![CDATA[>]]>= SYSDATE and
		start_date <![CDATA[<]]>= SYSDATE and
		rgstDate <![CDATA[<]]>= SYSDATE
	</select>
	 -->
	 
	 <!-- 축제 페이지 -->
	 <select id="festivalListDao" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice
	            FROM event
	            WHERE UPPER(type) LIKE '축제%'
	            ORDER BY eventNum DESC
	        ) A
	    )
	    WHERE PAGE=#{param2}
	 </select>
	 
	 <select id="totalFestivalCountDao" resultType="int">
		SELECT COUNT(*) FROM event WHERE UPPER(type) LIKE '축제%'
	</select>
	 
	<!-- 전시 페이지 -->
	 <select id="exhibitionListDao" resultType="com.festicket.dto.EventDto">
	 	SELECT eventNum, main_img, title, place, eventDate, eventPrice
	    FROM (
	        SELECT A.*, FLOOR(((ROWNUM-1) / #{param1}) + 1) AS PAGE, ROWNUM AS RN
	        FROM (
	            SELECT eventNum, main_img, title, place, eventDate, eventPrice
	            FROM event
	            WHERE UPPER(type) LIKE '전시%'
	            ORDER BY eventNum DESC
	        ) A
	    )
	    WHERE PAGE=#{param2}
	 </select>
	 
	 <select id="totalExhibitionCountDao" resultType="int">
		SELECT COUNT(*) FROM event WHERE UPPER(type) LIKE '전시%'
	</select>
	
</mapper>